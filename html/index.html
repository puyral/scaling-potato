

<!DOCTYPE html>
<html>
    <head>
        <title>Cours Complet Bootstrap 4</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <style>
            .custom-line{
                min-height: 5rem;
                margin-bottom: 1rem;
                background-color: RGBa(60,240,160,0.7); /*Vert*/
            }
            .custom-line > .col{
                background-color: RGBa(60,120,240,0.7); /*Bleu*/
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    </head>
    <body>



    <!-- Optional JavaScript -->

        <!--Les classes bg-info et mb-3 servent à appliquer un fond bleu et une marge extérieure basse de 
         taille moyenne au div-->

        <!--La classe border ajoute des bordures grises autour de l'élément--> <div class="container">
            
             <div class="container">
           <!--Les classes .p-3 et .mb-2 servent simplement à définir un 
           padding et une marge extérieure basse pour séparer nos divs.
           La classe border permet d'ajouter des bordures-->

        <h1>Get all the users info</h1>

            

            <!-- Button for selecting users -->

            <form>
               <fieldset>
                 <legend>Research now the pseudo of a wikipedia users to get all his profile.</legend>
                 
                 <div class="form-group">
                   <label >Users Name : </label>
                   <input type="text" class="form-control" id="usersName" placeholder="A3nm">
                 </div>
                 
                 <div class="form-group">
                   <label >Language?</label>
                   <input type="text" class="form-control" id="language" placeholder="fr">
                 </div>
                 

                <div class="form-group">
                   <label >Number of queries?</label>
                   <input type="text" class="form-control" id="nbQueries" placeholder="50">
                 </div>

               </fieldset>
             </form>


            <button type="button" class ="btn btn-success mb-2" onclick="getValue();">Go !</button>
            

            <!-- General info about the users -->
            <p id="name"></p>
            <p id="blockinfo"></p>
            <p id="groups"></p>
            <p id="editcount"></p>
            <p id="registration"></p>
            <p id="emailable"></p>
            <p id="gender"></p>

            <!-- All the queries he did  -->

            <!--<p id="infoE"></p> -->


            <div class="container" id="tab">

            


            </div>

            </div>



       </div>
     
    </body>
</html>



<script type="text/javascript">
    

    function getValue() {  /* function to get the value in the input*/ 


        var usersName = document.getElementById("usersName").value;
        var language = document.getElementById("language").value;
        var nbQueries = document.getElementById("nbQueries").value;

        changeThings(usersName,language,nbQueries);
    }

    function changeThings(usersName,language,nbQueries){ /*To update with the value that we get from the input*/

        /* We construct the first url , to get the info about the user*/
        var url = "https://"+ language+ ".wikipedia.org/w/api.php"; 
        var params = {
            action: "query",
            list: "users",
            ususers: usersName,
            usprop: "blockinfo|groups|editcount|registration|emailable|gender",
            format: "json"
        };

        url = url + "?origin=*";
        Object.keys(params).forEach(function(key){url += "&" + key + "=" + params[key];});   
        console.log(url);
        fetch(url)
            .then(function(response){return response.json();})
            .then(function(response) {
                /*Define all the variables usefull to show after*/
                var users = response.query.users;
                var xname = users[0].name;
                var xblockinfo = users[0].blockinfo;
                var xgroups = users[0].groups;
                var xeditcount = users[0].editcount;
                var xregistration = users[0].registration;
                var xemailable = users[0].emailable;
                var xgender = users[0].gender;
                /*Show the different value*/
                document.getElementById("name").innerHTML =
                    " <strong> Nom de l'utilisateur : </strong> " +xname;
                document.getElementById("blockinfo").innerHTML =
                    " " +xblockinfo;
                document.getElementById("groups").innerHTML =
                    "<strong>Groupe de l'utilisateur : </strong> " +xgroups;
                document.getElementById("editcount").innerHTML =
                    "<strong>Nombre d'édits de l'utilisateur : </strong> " +xeditcount;
                document.getElementById("registration").innerHTML =
                    "<strong> Date d'enregistrement sur wikipedia : </strong> " +xregistration;
                document.getElementById("emailable").innerHTML =
                    " <strong>Email, si renseigné : </strong> " +xemailable;

            })

        /*Second request to get the different queries of that user*/
        var url = "https://"+ language+ ".wikipedia.org/w/api.php"; 
        var params = {
            action: "query",
            list: "usercontribs",
            ucuser: usersName,
            ucprop: "ids|title|comment|size|sizediff|timestamp|tags",
            format: "json",
            ucshow:"!minor",
            uclimit:nbQueries,
            ucnamespace:"0"
        };

        url = url + "?origin=*";
        Object.keys(params).forEach(function(key){url += "&" + key + "=" + params[key];}); /*Constructing the url*/
        console.log(url);

        fetch(url)
            .then(function(response){return response.json();})
            .then(function(response) {
                var usercontribs = response.query.usercontribs; 
                /*var x = ""; /* The following variable will contain all the important info about the queries of the users and then will be print in the different columns */

                var PagesEdits = "";
                var DaysEdits = "";
                var DeltaEdits = "";
                var CategoriesEdits = "";


                console.log(usercontribs);
                console.log("MERDEEEEE");
                usersC = usercontribs.sort(function(a,b){   /*We sort the contribution by the absolute value of delta size */
                    if (Math.abs(a.sizediff) < Math.abs(b.sizediff) ){ return 1; } 
                    if (Math.abs(a.sizediff) > Math.abs(b.sizediff) ){ return -1;}
                    return 0; 
                })





                var L = "";
                for (var u in usercontribs){
                    
                    L+="|"+usercontribs[u].title;
                }
                
                L = L.substring(1,L.length);
                console.log(L);




                    

                /* For each pages that the user has edited, we research for the category*/
                var url = "https://"+language+".wikipedia.org/w/api.php"; 
                var params = {
                    action: "query",
                    format: "json",
                    prop: "categories",
                    clshow: "!hidden",
                    cllimit:500,
                    titles: L
                };

                url = url + "?origin=*";
                Object.keys(params).forEach(function(key){url += "&" + key + "=" + params[key];});
                let categ = ""; /*Variable that will contains all the categories of these page*/
                let usercontribsu = usercontribs[u];
                console.log(url);
                fetch(url)   /*from here it start to bug I don't know why. Maybe there is some latency in the response to the different queries, maybe I shuold wait for the timing to get the response ? */
                    .then(function(response){return response.json();})
                    .then(function(response) {
                        var pages = response.query.pages;
                       

                        var L = {};


                        for (var p in pages) {
                            let categ = "";


                            try {

                                for (var cat of pages[p].categories) {
                                categ += cat.title+"  ;  " ; /* We add the categories*/
                                }

                                L[pages[p].title]=categ;


                            } catch(TypeError) {

                                categ = "";

                            }


                            

                           

                        }
                        
                        /*We add all the différent informations about the edit in x*/



                        console.log(L);


                        document.getElementById("tab").innerHTML = "<div class='row'> <div class='col bg-info' > Page </div> <div class='col bg-info' > Jour de l'édit </div> <div class='col bg-info' > DeltaSize </div> <div class='col bg-info' > Categories </div></div>";

           
                        for (var u in usersC){


                            PagesEdit = usercontribs[u].title;
                            DaysEdit = usercontribs[u].timestamp ;
                            DeltaEdit = usercontribs[u].sizediff;
                            CategoriesEdit = L[usercontribs[u].title];

                            /*
                             x += "<strong>  " + usercontribs[u].user + "</strong> on the <strong>"  + usercontribs[u].timestamp  + "</strong> edit the following page : <strong>" + usercontribs[u].title + "</strong>." + "The delta size is  <strong>" + usercontribs[u].sizediff + "</strong> between the last version and these one." + "The tag is then : " + usercontribs[u].tags + "." + "The page is in various categories such as : <strong>" + L[usercontribs[u].title] + "</strong>" ;

                            x += "<br />";*/
                            
                
                        /**/
                    

                        document.getElementById("tab").innerHTML += "<div class='row'> <div class='col bg-info' >"+PagesEdit+"</div> <div class='col bg-info' >"+DaysEdit+"  </div> <div class='col bg-info' > "+DeltaEdit+" </div> <div class='col bg-info' > "+CategoriesEdit+" </div></div>";

                        
                                }
                            /*
                        document.getElementById("infoE").innerHTML = "" +x;
                                         */

                    })

/*Chaos is ladder*/
          
                    
                


    })

    }

</script>
