

<!DOCTYPE html>
<html>
    <head>
        <title>Cours Complet Bootstrap 4</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <style>
            .custom-line{
                min-height: 5rem;
                margin-bottom: 1rem;
                background-color: RGBa(60,240,160,0.7); /*Vert*/
            }
            .custom-line > .col{
                background-color: RGBa(60,120,240,0.7); /*Bleu*/
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    </head>
    <body>



    <!-- Optional JavaScript -->

        <!--Les classes bg-info et mb-3 servent à appliquer un fond bleu et une marge extérieure basse de 
         taille moyenne au div-->

        <!--La classe border ajoute des bordures grises autour de l'élément--> <div class="container">
            
             <div class="container">
           <!--Les classes .p-3 et .mb-2 servent simplement à définir un 
           padding et une marge extérieure basse pour séparer nos divs.
           La classe border permet d'ajouter des bordures-->

        <h1>Get all the users info</h1>

            <div class='row'> 
                <div class='col bg-info' >
                

                       <form>
                       <fieldset>
                         <legend>Research now the pseudo of a wikipedia users to get all his profile.</legend>
                         
                         <div class="form-group">
                           <label >Users Name : </label>
                           <input type="text" class="form-control" id="usersName" placeholder="A3nm">
                         </div>
                         
                         <div class="form-group">
                           <label >Language?</label>
                           <input type="text" class="form-control" id="language" placeholder="fr">
                         </div>
                         

                        <div class="form-group">
                           <label >Number of queries?</label>
                           <input type="text" class="form-control" id="nbQueries" placeholder="50">
                         </div>

                       </fieldset>
                     </form>



                </div>
                <div class='col bg-info' > 

                     <!-- General info about the users -->


                    <div class='row'> 
                        <div class='col bg-info' >
                            <p id="name"> <strong> Nom de l'utilisateur : </strong> </p>
                        </div>

                        <div class='col bg-info' >
                            <p id="groups">
                    <strong>Groupe de l'utilisateur : </strong> </p>
                        </div>

                    </div>
                    <div class='row'> 
                        <div class='col bg-info' >
                            <p id="editcount">
                    <strong>Nombre d'édits de l'utilisateur : </strong> </p>
                        </div>

                        <div class='col bg-info' >
                            <p id="registration"><strong> Date d'enregistrement sur wikipedia : </strong> </p>
                        </div>
                    </div>
                    <div class='row'> 
                        <div class='col bg-info' >
                             <p id="emailable"> <strong>Email, si renseigné : </strong> </p>
                        </div>


                        <div class='col bg-info' >
                            
                    <p id="latestcontrib"> <strong>Dernière modification le : </strong> </p>

                        </div>

                    </div>

                    
                   

                    <!--<p id="gender"></p> -->
                </div> 
            </div>

            
            <div class='row'> 
                <button type="button" class ="btn btn-success mb-2" onclick="getValue();">Go !</button>
            </div>


           
            <!-- All the queries he did  -->

            <!--<p id="infoE"></p> -->


            <div class="container" id="tab">

            


            </div>

            </div>



       </div>
     
    </body>
</html>



<script type="text/javascript">
    

    function getValue() {  /* function to get the value in the input*/ 


        var usersName = document.getElementById("usersName").value;
        var language = document.getElementById("language").value;
        var nbQueries = document.getElementById("nbQueries").value;

        changeThings(usersName,language,nbQueries);
    }



    function createRow(PagesEdit,DaysEdit,DeltaEdit,CategoriesEdit,language){  /* Creates the row off the tab */


        var URLpage = createURLpage(PagesEdit,language);
        

        document.getElementById("tab").innerHTML += "<div class='row'> <div class='col bg-info' >"+URLpage+"</div> <div class='col bg-info' >"+DaysEdit+"  </div> <div class='col bg-info' > "+DeltaEdit+" </div> <div class='col bg-info' > "+CategoriesEdit+" </div></div>";

    }


    function createURLpage(name,language){   /*  Creer le lien pour la page wikipedia qu'on souhaite */
        name2 = name.split(' ').join('_');
        var url = "https://"+language+".wikipedia.org/wiki/"+name2;
        var complet = "<a href="+url+">"+name+"</a>";
        return complet;
    }


    function createRows(b,usersC,L,language){/* Go through all the queries the users made (usersC), and display in a tab the differentes queries with relevant information  */ 
        a = 0;
        for (var u in usersC){

            if (Math.floor(a/50) ==b){

                PagesEdit = usersC[u].title;
                DaysEdit = usersC[u].timestamp ;
                DeltaEdit = usersC[u].sizediff;
                CategoriesEdit = L[usersC[u].title];

               createRow(PagesEdit,DaysEdit,DeltaEdit,CategoriesEdit,language);
            }
            a+=1;
        }
    }


    function changeThings(usersName,language,nbQueries){ /*To update with the value that we get from the input*/

        /* We construct the first url , to get the info about the user*/
        var url = "https://"+ language+ ".wikipedia.org/w/api.php"; 
        var params = {
            action: "query",
            list: "users",
            ususers: usersName,
            usprop: "blockinfo|groups|editcount|registration|emailable|gender",
            format: "json"
        };

        url = url + "?origin=*";
        Object.keys(params).forEach(function(key){url += "&" + key + "=" + params[key];});   
        console.log(url);
        fetch(url)
            .then(function(response){return response.json();})
            .then(function(response) {
                /*Define all the variables usefull to show after*/
                var users = response.query.users;
                var xname = users[0].name;
                var xblockinfo = users[0].blockinfo;
                var xgroups = users[0].groups;
                var xeditcount = users[0].editcount;
                var xregistration = users[0].registration;
                var xemailable = users[0].emailable;
                var xgender = users[0].gender;
                /*Show the different value*/
                document.getElementById("name").innerHTML =+xname;
                /*document.getElementById("blockinfo").innerHTML =+xblockinfo;*/
                document.getElementById("groups").innerHTML =+xgroups;
                document.getElementById("editcount").innerHTML =+xeditcount;
                document.getElementById("registration").innerHTML =+xregistration;
                document.getElementById("emailable").innerHTML =+xemailable;

            })


        /*Get the number of view for each page*/


        




        /*Second request to get the different queries of that user*/

        var url = "https://"+ language+ ".wikipedia.org/w/api.php"; 
        var params = {
            action: "query",
            list: "usercontribs",
            ucuser: usersName,
            ucprop: "ids|title|comment|size|sizediff|timestamp|tags",
            format: "json",
            ucshow:"!minor",
            uclimit:nbQueries,
            ucnamespace:"0"
        };

        url = url + "?origin=*";
        Object.keys(params).forEach(function(key){url += "&" + key + "=" + params[key];}); /*Constructing the url*/
        console.log(url);

        fetch(url)
            .then(function(response){return response.json();})
            .then(function(response) {
                var usercontribs = response.query.usercontribs; 
                



                document.getElementById("tab").innerHTML = "<div class='row'> <div class='col bg-info' > Page </div> <div class='col bg-info' > Jour de l'édit </div> <div class='col bg-info' > DeltaSize </div> <div class='col bg-info' > Categories </div></div>";

                usersC = usercontribs.sort(function(a,b){   /*We sort the contribution by the absolute value of delta size. */
                    if (Math.abs(a.sizediff) < Math.abs(b.sizediff) ){ return 1; } 
                    if (Math.abs(a.sizediff) > Math.abs(b.sizediff) ){ return -1;}
                    return 0; 
                })


                /*With that sorted we have a first approximation of the different importance of queries */

                /*We are now going to construct 10 different url in order to do 10 diferent fetch. We have to do this because of certain 
                wikipedia restrictions*/
                var L1 = "";  
                var L2 ="";
                var L3 ="";
                var L4 ="";
                var L5 ="";
                var L6 ="";
                var L7 ="";
                var L8 ="";
                var L9 ="";
                var L10 ="";

                
                var Dicti = {}

                for (i = 0; i <10 ; i ++) {

                    Dicti[i+1] = 0;
                }

                var a = 0;
                for (var u in usersC){

                    switch(Math.floor(a/50)) {
                        case 0 :
                            L1+="|"+usercontribs[u].title;
                            Dicti[1] += 1;
                            break;               
                        case 1 :

                            L2+="|"+usercontribs[u].title;
                            Dicti[2] += 1;
                            break;
                        case 2 :

                            L3+="|"+usercontribs[u].title;
                            Dicti[3] += 1;
                            break;
                        case 3 :

                            L4+="|"+usercontribs[u].title;
                            Dicti[4] += 1;
                            break;
                        case 4 :

                            L5+="|"+usercontribs[u].title;
                            Dicti[5] += 1;
                            break;
                        case 5 :

                            L6+="|"+usercontribs[u].title;
                            Dicti[6] += 1;
                            break;
                        case 6 :

                            L7+="|"+usercontribs[u].title;
                            Dicti[7] += 1;
                            break;
                        case 7 :

                            L8+="|"+usercontribs[u].title;
                            Dicti[8] += 1;
                            break;
                        case 8 :

                            L9+="|"+usercontribs[u].title;
                            Dicti[9] += 1;
                            break;
                        case 9 :

                            L10+="|"+usercontribs[u].title;
                            Dicti[10] += 1;
                            break;
                    }
                    a+=1;
                }
                
                for (i = 0;i<10;i++){

                    console.log(Dicti[i+1]);
                }

                console.log(usersC);
                L1 = L1.substring(1,L1.length);
                L2 = L2.substring(1,L2.length);
                L3 = L3.substring(1,L3.length);
                L4 = L4.substring(1,L4.length);
                L5 = L5.substring(1,L5.length);
                L6 = L6.substring(1,L6.length);
                L7 = L7.substring(1,L7.length);
                L8 = L8.substring(1,L8.length);
                L9 = L9.substring(1,L9.length);
                L10 = L10.substring(1,L10.length);

                /* Here comes the url*/
                var url1 = "https://"+language+".wikipedia.org/w/api.php";
                var url2 = "https://"+language+".wikipedia.org/w/api.php"; 
                var url3 = "https://"+language+".wikipedia.org/w/api.php"; 
                var url4 = "https://"+language+".wikipedia.org/w/api.php"; 
                var url5 = "https://"+language+".wikipedia.org/w/api.php"; 
                var url6 = "https://"+language+".wikipedia.org/w/api.php"; 
                var url7 = "https://"+language+".wikipedia.org/w/api.php"; 
                var url8 = "https://"+language+".wikipedia.org/w/api.php"; 
                var url9 = "https://"+language+".wikipedia.org/w/api.php"; 
                var url10 = "https://"+language+".wikipedia.org/w/api.php"; 


                var dictURL = {};
                var params = {
                    action: "query",
                    format: "json",
                    prop: "categories|pageviews|links|linkshere",
                    clshow: "!hidden",
                    cllimit:500,
                    titles: "",
                    pllimit : 50
                };

                for (i = 0; i<11;i++){
                    switch(i){

                        case 0:
                            params["titles"] = L1
                            url1 = url1 + "?origin=*";
                            Object.keys(params).forEach(function(key){url1 += "&" + key + "=" + params[key];});
                            dictURL[1] = url1;
                            break;                             

                        case 1:
                            params["titles"] = L2
                            url2 = url2 + "?origin=*";
                            Object.keys(params).forEach(function(key){url2 += "&" + key + "=" + params[key];});
                            dictURL[2] = url2;
                            break; 

                        case 2:
                            params["titles"] = L3
                            url3 = url3 + "?origin=*";
                            Object.keys(params).forEach(function(key){url3 += "&" + key + "=" + params[key];});
                            dictURL[3] = url3;
                            break; 

                        case 3:
                            params["titles"] = L4
                            url4 = url4 + "?origin=*";
                            Object.keys(params).forEach(function(key){url4 += "&" + key + "=" + params[key];});
                            dictURL[4] = url4;
                            break; 

                        case 4:
                            params["titles"] = L5
                            url5 = url5 + "?origin=*";
                            Object.keys(params).forEach(function(key){url5 += "&" + key + "=" + params[key];});
                            dictURL[5] = url5;
                            break; 


                        case 5:
                            params["titles"] = L6
                            url6 = url6 + "?origin=*";
                            Object.keys(params).forEach(function(key){url6 += "&" + key + "=" + params[key];});
                            dictURL[6] = url6;
                            break; 

                        case 6:
                            params["titles"] = L7
                            url7 = url7 + "?origin=*";
                            Object.keys(params).forEach(function(key){url7 += "&" + key + "=" + params[key];});
                            dictURL[7] = url7;
                            break; 

                        case 7:
                            params["titles"] = L8
                            url8 = url8 + "?origin=*";
                            Object.keys(params).forEach(function(key){url8 += "&" + key + "=" + params[key];});
                            dictURL[8] = url8;
                            break; 

                        case 8:
                            params["titles"] = L9
                            url9 = url9 + "?origin=*";
                            Object.keys(params).forEach(function(key){url9 += "&" + key + "=" + params[key];});
                            dictURL[9] = url9;
                            break; 

                        case 9:
                            params["titles"] = L10
                            url10 = url10 + "?origin=*";
                            Object.keys(params).forEach(function(key){url10 += "&" + key + "=" + params[key];});
                            dictURL[10] = url10;
                            break; 


                    }
                }


                console.log(dictURL[1]);
                let categ = ""; 
                var L = {};
            
                Promise.all( [
                    



                        /*We do all the fetch in a promise all to gather them in one, and then we can go through all the data.*/
                        fetch(dictURL[1]).then(resp => resp.json()),
                        fetch(dictURL[2]).then(resp => resp.json()),
                        fetch(dictURL[3]).then(resp => resp.json()),
                        fetch(dictURL[4]).then(resp => resp.json()),
                        fetch(dictURL[5]).then(resp => resp.json()),
                        fetch(dictURL[6]).then(resp => resp.json()),
                        fetch(dictURL[7]).then(resp => resp.json()),
                        fetch(dictURL[8]).then(resp => resp.json()),
                        fetch(dictURL[9]).then(resp => resp.json()),
                        fetch(dictURL[10]).then(resp => resp.json())
                    
                    ]).then(function(response){

                        console.log(response);
                        var L = {};
                        var pageViews = [];

                        var links = [];
                        var linkshere = []; 


                        for (i= 0;i<10; i++){  /* For each fetchs… there is 10 fetchs*/ 

                            if (Dicti[i+1] >0) { /* Do this only if this fetch if interesting*/

                                var pages = response[i].query.pages;
                                for (var p in pages) {
                                    let categ = "";  /*Variable that will contains all the categories of these page*/
                                    try {
                                        for (var cat of pages[p].categories) {
                                        categ += cat.title+"  ;  " ; /* We add the categories*/
                                        }
                                        L[pages[p].title]=categ;
                                    } catch(TypeError) {
                                        categ = "";
                                    }
                                    key = Object.keys(pages[p].pageviews);
                                    try {
                                        
                                        
                                        console.log("aludi,t,c2222777777777777777777777777777777777777777");
                                        console.log(pages[p].title);
                                        pageViews.push([pages[p].title,pages[p].pageviews[key[0]]]);

                                        links.push([pages[p].title,pages[p].links]);
                                        linkshere.push([pages[p].title,pages[p].linkshere]);

                                    }

                                    catch(TypeError){
                                        console.log("Bon je supose que je suis ici  du coup …");
                                        var huitre = 0;
                                    }
                                    
                                    
                                }     
                            }
                            
                        }
                        console.log(pageViews);

                        var sortedpageViews = pageViews.sort(function(a,b){   /*We sort the contribution by the absolute value of delta size. */
                            if (a[1] < b[1] ){ return 1; } 
                            if (b[1] < a[1] ) { return -1;}
                            return 0; 
                        })
                        console.log(sortedpageViews);



                        console.log(links);
                        console.log(linkshere);
                        console.log(language);
                        for (b = 0;b<10;b++){

                            if (Dicti[b+1] >0) {
                                createRows(b,usersC,L,language);
                            }
                        }
                    })

                  
    })

    }

</script>
